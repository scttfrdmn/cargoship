---
stages:
  - test
  - release
release:
  stage: release
  image:
    name: gitlab-registry.oit.duke.edu/devil-ops/goreleaser:v0-1-5
    entrypoint: ['']
# rules:
#   - if: '$CI_COMMIT_TAG =~ /v[0-9]+\.[0-9]+\.[0-9]+/ '
  variables:
    # Disable shallow cloning so that goreleaser can diff between tags to
    # generate a changelog.
    GIT_DEPTH: 0
  script:
#   - eval $(/scripts/vault-env.sh ssi-systems-${CI_PROJECT_NAME}-packaging)
    - goreleaser check
    - goreleaser release --rm-dist
  retry:
    max: 2
    when: runner_system_failure
